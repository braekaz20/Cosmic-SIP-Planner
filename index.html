<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cosmic SIP Planner</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700&family=Montserrat:wght@300;400;500;600&display=swap" rel="stylesheet">
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/prop-types/15.8.1/prop-types.min.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.2/babel.min.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/recharts/2.12.7/Recharts.min.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      --cosmic-indigo: #1a1a3a;
      --nebula-purple: #4e2a8e;
      --aurora-teal: #00c9b8;
      --supernova-pink: #ff2d75;
      --starlight-blue: #00a8ff;
      --dark-matter: #0a0a1a;
      --cosmic-dust: #2d2d5a;
    }
    
    body {
      font-family: 'Montserrat', sans-serif;
      background: var(--cosmic-indigo);
      color: #e0e0ff;
    }
    
    h1, h2, h3, h4 {
      font-family: 'Orbitron', sans-serif;
      letter-spacing: 0.5px;
    }
    
    .cosmic-card {
      background: rgba(26, 26, 58, 0.7);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(78, 42, 142, 0.3);
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      transition: all 0.3s ease;
    }
    
    .cosmic-card:hover {
      border-color: rgba(0, 201, 184, 0.5);
      box-shadow: 0 8px 32px rgba(0, 201, 184, 0.2);
    }
    
    .cosmic-input {
      background: rgba(10, 10, 26, 0.5);
      border: 1px solid var(--cosmic-dust);
      color: #e0e0ff;
      transition: all 0.3s ease;
    }
    
    .cosmic-input:focus {
      border-color: var(--aurora-teal);
      box-shadow: 0 0 0 2px rgba(0, 201, 184, 0.2);
      outline: none;
    }
    
    .cosmic-button {
      background: linear-gradient(135deg, var(--nebula-purple), var(--supernova-pink));
      color: white;
      border: none;
      transition: all 0.3s ease;
    }
    
    .cosmic-button:hover {
      background: linear-gradient(135deg, var(--supernova-pink), var(--nebula-purple));
      transform: translateY(-2px);
    }
    
    .cosmic-button-secondary {
      background: rgba(10, 10, 26, 0.5);
      border: 1px solid var(--cosmic-dust);
    }
    
    .cosmic-button-secondary:hover {
      border-color: var(--aurora-teal);
      background: rgba(0, 201, 184, 0.1);
    }
    
    .cosmic-table-header {
      background: rgba(78, 42, 142, 0.3);
    }
    
    .cosmic-table-row:hover {
      background: rgba(0, 168, 255, 0.05);
    }
    
    .cosmic-divider {
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(0, 201, 184, 0.5), transparent);
    }
    
    .thousands-badge {
      background: linear-gradient(135deg, rgba(0, 168, 255, 0.2), rgba(0, 168, 255, 0.4));
    }
    
    .lakhs-badge {
      background: linear-gradient(135deg, rgba(0, 201, 184, 0.2), rgba(0, 201, 184, 0.4));
    }
    
    .crores-badge {
      background: linear-gradient(135deg, rgba(255, 45, 117, 0.2), rgba(255, 45, 117, 0.4));
    }
    
    .recharts-tooltip {
      background: var(--dark-matter) !important;
      border: 1px solid var(--cosmic-dust) !important;
      border-radius: 8px !important;
    }
    
    .recharts-legend-item-text {
      color: #e0e0ff !important;
    }
    
    .recharts-cartesian-axis-tick-value {
      fill: #a0a0c0 !important;
    }
    
    @keyframes subtlePulse {
      0%, 100% { opacity: 0.8; }
      50% { opacity: 1; }
    }
    
    .pulse {
      animation: subtlePulse 3s infinite;
    }
    
    .border-glow {
      box-shadow: 0 0 10px rgba(0, 201, 184, 0.3);
    }
    
    .theme-light {
      --cosmic-indigo: #f0f4ff;
      --nebula-purple: #7b5dd6;
      --aurora-teal: #00a8a8;
      --supernova-pink: #ff4d8d;
      --starlight-blue: #0077cc;
      --dark-matter: #ffffff;
      --cosmic-dust: #d0d0e0;
    }
    
    .theme-pastel {
      --cosmic-indigo: #f5f0ff;
      --nebula-purple: #b399ff;
      --aurora-teal: #6ddfd5;
      --supernova-pink: #ff9bb8;
      --starlight-blue: #8ac6ff;
      --dark-matter: #ffffff;
      --cosmic-dust: #e0d0ff;
    }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect, useRef, useMemo } = React;
    const { PieChart, Pie, Cell, LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } = window.Recharts || {};

    const COLORS = ['#4e2a8e', '#00c9b8', '#ff2d75', '#00a8ff'];
    const THEMES = {
      cosmic: {
        bg: 'bg-[var(--cosmic-indigo)]',
        card: 'cosmic-card',
        text: 'text-[#e0e0ff]',
        border: 'border-[var(--cosmic-dust)]',
        input: 'cosmic-input',
        button: 'cosmic-button',
        buttonSecondary: 'cosmic-button-secondary',
        tableHeader: 'cosmic-table-header',
        tableRowHover: 'cosmic-table-row',
        thousands: 'thousands-badge',
        lakhs: 'lakhs-badge',
        crores: 'crores-badge',
        largeCapBorder: 'border-[#4e2a8e]',
        midCapBorder: 'border-[#00c9b8]',
        smallCapBorder: 'border-[#ff2d75]',
        totalBorder: 'border-[#00a8ff]',
      },
      light: {
        bg: 'bg-[var(--cosmic-indigo)] theme-light',
        card: 'cosmic-card bg-white',
        text: 'text-gray-800',
        border: 'border-[var(--cosmic-dust)]',
        input: 'cosmic-input bg-white',
        button: 'cosmic-button',
        buttonSecondary: 'cosmic-button-secondary bg-gray-100',
        tableHeader: 'bg-gray-100',
        tableRowHover: 'hover:bg-gray-50',
        thousands: 'bg-blue-100 text-blue-800',
        lakhs: 'bg-teal-100 text-teal-800',
        crores: 'bg-pink-100 text-pink-800',
        largeCapBorder: 'border-purple-300',
        midCapBorder: 'border-teal-300',
        smallCapBorder: 'border-pink-300',
        totalBorder: 'border-blue-300',
      },
      pastel: {
        bg: 'bg-[var(--cosmic-indigo)] theme-pastel',
        card: 'cosmic-card bg-white',
        text: 'text-purple-900',
        border: 'border-[var(--cosmic-dust)]',
        input: 'cosmic-input bg-white',
        button: 'cosmic-button',
        buttonSecondary: 'cosmic-button-secondary bg-purple-50',
        tableHeader: 'bg-purple-100',
        tableRowHover: 'hover:bg-purple-50',
        thousands: 'bg-blue-100 text-blue-900',
        lakhs: 'bg-teal-100 text-teal-900',
        crores: 'bg-pink-100 text-pink-900',
        largeCapBorder: 'border-purple-300',
        midCapBorder: 'border-teal-300',
        smallCapBorder: 'border-pink-300',
        totalBorder: 'border-blue-300',
      },
    };

    const ChartErrorBoundary = ({ children }) => {
      const [hasError, setHasError] = useState(false);
      useEffect(() => {
        if (!window.Recharts) setHasError(true);
      }, []);
      if (hasError || !LineChart) {
        return <span className="text-gray-500">-</span>;
      }
      return children;
    };

    const ErrorBoundary = ({ children }) => {
      const [hasError, setHasError] = useState(false);
      if (hasError) {
        return <div className="text-red-500 p-6">Something went wrong. Please refresh or adjust your inputs.</div>;
      }
      return children;
    };

    const App = () => {
      const [sipAmount, setSipAmount] = useState(10000);
      const [lumpsumAmount, setLumpsumAmount] = useState(0);
      const [stepUpPercent, setStepUpPercent] = useState(10);
      const [investmentHorizon, setInvestmentHorizon] = useState(10);
      const [largeCapPercent, setLargeCapPercent] = useState(40);
      const [midCapPercent, setMidCapPercent] = useState(40);
      const [smallCapPercent, setSmallCapPercent] = useState(20);
      const [largeCapCAGR, setLargeCapCAGR] = useState(12);
      const [midCapCAGR, setMidCapCAGR] = useState(15);
      const [smallCapCAGR, setSmallCapCAGR] = useState(18);
      const [fdRate, setFdRate] = useState(6.5);
      const [inflationRate, setInflationRate] = useState(6);
      const [taxRate, setTaxRate] = useState(10);
      const [goals, setGoals] = useState([{ id: 1, name: 'Goal 1', amount: 1000000, years: 10, requiredSIP: 0 }]);
      const [theme, setTheme] = useState('cosmic');
      const [results, setResults] = useState([]);
      const [visibleColumns, setVisibleColumns] = useState([
        'year',
        'largeCapInvested',
        'largeCapValue',
        'midCapInvested',
        'midCapValue',
        'smallCapInvested',
        'smallCapValue',
        'totalInvested',
        'totalValue',
        'profit',
        'tax',
        'postTaxValue',
        'realValue',
      ]);
      const reportRef = useRef(null);

      const totalPercent = Number(largeCapPercent) + Number(midCapPercent) + Number(smallCapPercent);
      const isValidPercent = Math.abs(totalPercent - 100) < 0.01;

      const formatNumber = (value) => {
        if (value === undefined || value === null || isNaN(value)) return 'â‚¹0';
        return `â‚¹${Number(value).toLocaleString('en-IN')}`;
      };

      const getRealValueColorAndIcon = (value) => {
        if (value >= 10000000) {
          return { className: THEMES[theme].crores, icon: 'ðŸ’Ž' };
        }
        if (value >= 1000000) {
          return { className: THEMES[theme].lakhs, icon: 'ðŸ’µ' };
        }
        return { className: THEMES[theme].thousands, icon: 'ðŸª™' };
      };

      useEffect(() => {
        const calculateSIP = () => {
          const yearlyData = [];
          let currentSip = sipAmount || 0;
          let largeCapInvested = (lumpsumAmount || 0) * (largeCapPercent / 100);
          let midCapInvested = (lumpsumAmount || 0) * (midCapPercent / 100);
          let smallCapInvested = (lumpsumAmount || 0) * (smallCapPercent / 100);
          let largeCapValue = largeCapInvested;
          let midCapValue = midCapInvested;
          let smallCapValue = smallCapInvested;
          let fdValue = lumpsumAmount || 0;

          for (let year = 1; year <= (investmentHorizon || 1); year++) {
            const largeCapMonthly = (currentSip * (largeCapPercent / 100)) || 0;
            const midCapMonthly = (currentSip * (midCapPercent / 100)) || 0;
            const smallCapMonthly = (currentSip * (smallCapPercent / 100)) || 0;

            largeCapInvested += largeCapMonthly * 12;
            midCapInvested += midCapMonthly * 12;
            smallCapInvested += smallCapMonthly * 12;

            largeCapValue = largeCapInvested * Math.pow(1 + (largeCapCAGR || 0) / 100, year);
            midCapValue = midCapInvested * Math.pow(1 + (midCapCAGR || 0) / 100, year);
            smallCapValue = smallCapInvested * Math.pow(1 + (smallCapCAGR || 0) / 100, year);
            fdValue += (currentSip * 12) * Math.pow(1 + (fdRate || 0) / 100, year);

            const totalInvested = largeCapInvested + midCapInvested + smallCapInvested;
            const totalValue = largeCapValue + midCapValue + smallCapValue;
            const profit = totalValue - totalInvested;
            const taxableGain = profit > 125000 ? profit - 125000 : 0;
            const tax = taxableGain * ((taxRate || 0) / 100);
            const postTaxValue = totalValue - tax;
            const realValue = totalValue / Math.pow(1 + (inflationRate || 0) / 100, year);

            yearlyData.push({
              year: `Year ${year}`,
              largeCapInvested: largeCapInvested || 0,
              largeCapValue: largeCapValue || 0,
              midCapInvested: midCapInvested || 0,
              midCapValue: midCapValue || 0,
              smallCapInvested: smallCapInvested || 0,
              smallCapValue: smallCapValue || 0,
              totalInvested: totalInvested || 0,
              totalValue: totalValue || 0,
              fdValue: fdValue || 0,
              profit: profit || 0,
              tax: tax || 0,
              postTaxValue: postTaxValue || 0,
              realValue: realValue || 0,
            });

            currentSip *= 1 + ((stepUpPercent || 0) / 100);
          }

          const updatedGoals = goals.map((goal) => {
            const avgCAGR = ((largeCapPercent * largeCapCAGR + midCapPercent * midCapCAGR + smallCapPercent * smallCapCAGR) / 100) || 0;
            const monthlyRate = avgCAGR / 1200;
            const months = (goal.years || 1) * 12;
            const requiredSIP = goal.amount / ((Math.pow(1 + monthlyRate, months) - 1) / monthlyRate) || 0;
            return { ...goal, requiredSIP: Math.round(requiredSIP) };
          });
          setGoals(updatedGoals);

          setResults(yearlyData);
        };

        if (isValidPercent) {
          calculateSIP();
        }
      }, [sipAmount, lumpsumAmount, stepUpPercent, investmentHorizon, largeCapPercent, midCapPercent, smallCapPercent, largeCapCAGR, midCapCAGR, smallCapCAGR, fdRate, inflationRate, taxRate, goals]);

      const handlePercentChange = (setter, value, other1, other2, setOther1, setOther2) => {
        const numValue = Math.max(0, Math.min(100, parseFloat(value) || 0));
        setter(numValue);
        const remaining = 100 - numValue;
        const totalOther = (other1 || 0) + (other2 || 0);
        if (totalOther > 0) {
          const newOther1 = (other1 / totalOther) * remaining;
          const newOther2 = (other2 / totalOther) * remaining;
          setOther1(Math.round(newOther1 * 100) / 100);
          setOther2(Math.round(newOther2 * 100) / 100);
        }
      };

      const addGoal = () => {
        setGoals([...goals, { id: goals.length + 1, name: `Goal ${goals.length + 1}`, amount: 1000000, years: 10, requiredSIP: 0 }]);
      };

      const updateGoal = (id, field, value) => {
        setGoals(goals.map((goal) => (goal.id === id ? { ...goal, [field]: value } : goal)));
      };

      const downloadPDF = () => {
        if (!reportRef.current || !window.html2pdf) return;
        const element = reportRef.current;
        const opt = {
          margin: 0.5,
          filename: "Cosmic_SIP_Plan.pdf",
          image: { type: "jpeg", quality: 0.98 },
          html2canvas: { scale: 2 },
          jsPDF: { unit: "in", format: "letter", orientation: "portrait" },
        };
        window.html2pdf().from(element).set(opt).save();
      };

      const toggleColumn = (column) => {
        if (visibleColumns.includes(column)) {
          setVisibleColumns(visibleColumns.filter((c) => c !== column));
        } else {
          setVisibleColumns([...visibleColumns, column]);
        }
      };

      const sparklineData = useMemo(() => {
        return results.map((row, index) => ({
          year: row.year,
          realValue: row.realValue,
          profit: row.profit,
          index,
        }));
      }, [results]);

      const columns = [
        { key: 'year', label: 'Year', mandatory: true },
        { key: 'largeCapInvested', label: 'Large Cap Invested', border: THEMES[theme].largeCapBorder },
        { key: 'largeCapValue', label: 'Large Cap Value', border: THEMES[theme].largeCapBorder },
        { key: 'midCapInvested', label: 'Mid Cap Invested', border: THEMES[theme].midCapBorder },
        { key: 'midCapValue', label: 'Mid Cap Value', border: THEMES[theme].midCapBorder },
        { key: 'smallCapInvested', label: 'Small Cap Invested', border: THEMES[theme].smallCapBorder },
        { key: 'smallCapValue', label: 'Small Cap Value', border: THEMES[theme].smallCapBorder },
        { key: 'totalInvested', label: 'Total Invested', border: THEMES[theme].totalBorder },
        { key: 'totalValue', label: 'Total Value', border: THEMES[theme].totalBorder },
        { key: 'profit', label: 'Profit', border: THEMES[theme].totalBorder },
        { key: 'tax', label: 'Tax', border: THEMES[theme].totalBorder },
        { key: 'postTaxValue', label: 'Post-Tax Value', border: THEMES[theme].totalBorder },
        { key: 'realValue', label: 'Real Value (Inflation-Adjusted)', border: THEMES[theme].totalBorder },
      ];

      return (
        <ErrorBoundary>
          <div className={`${THEMES[theme].bg} min-h-screen p-6 ${THEMES[theme].text}`}>
            <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
              <div>
                <h1 className="text-3xl md:text-4xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-[var(--aurora-teal)] to-[var(--starlight-blue)]">
                  Cosmic SIP Planner
                </h1>
                <p className="text-sm opacity-80">Visualize your financial future across the cosmos</p>
              </div>
              <div className="flex items-center gap-4">
                <select
                  value={theme}
                  onChange={(e) => setTheme(e.target.value)}
                  className={`${THEMES[theme].input} p-2 rounded-md ${THEMES[theme].border} cursor-pointer`}
                >
                  <option value="cosmic">Cosmic</option>
                  <option value="light">Light</option>
                  <option value="pastel">Pastel</option>
                </select>
                <button
                  onClick={downloadPDF}
                  className={`${THEMES[theme].button} px-4 py-2 rounded-md font-medium`}
                  disabled={!isValidPercent || results.length === 0}
                >
                  Download PDF
                </button>
              </div>
            </div>

            <div className={`${THEMES[theme].card} p-6 rounded-lg mb-8 ${THEMES[theme].border}`}>
              <h2 className="text-xl font-semibold mb-4">Your Investment Plan</h2>
              <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                  <label className="block text-sm font-medium mb-1">Monthly SIP (â‚¹)</label>
                  <input
                    type="number"
                    value={sipAmount}
                    onChange={(e) => setSipAmount(Math.max(0, parseFloat(e.target.value) || 0))}
                    className={`${THEMES[theme].input} mt-1 p-2 w-full rounded-md`}
                    min="0"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium mb-1">Lumpsum Amount (â‚¹)</label>
                  <input
                    type="number"
                    value={lumpsumAmount}
                    onChange={(e) => setLumpsumAmount(Math.max(0, parseFloat(e.target.value) || 0))}
                    className={`${THEMES[theme].input} mt-1 p-2 w-full rounded-md`}
                    min="0"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium mb-1">Annual Step-Up (%)</label>
                  <input
                    type="number"
                    value={stepUpPercent}
                    onChange={(e) => setStepUpPercent(Math.max(0, parseFloat(e.target.value) || 0))}
                    className={`${THEMES[theme].input} mt-1 p-2 w-full rounded-md`}
                    min="0"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium mb-1">Investment Horizon (Years)</label>
                  <input
                    type="number"
                    value={investmentHorizon}
                    onChange={(e) => setInvestmentHorizon(Math.max(1, parseInt(e.target.value) || 1))}
                    className={`${THEMES[theme].input} mt-1 p-2 w-full rounded-md`}
                    min="1"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium mb-1">Large Cap Allocation (%)</label>
                  <input
                    type="number"
                    value={largeCapPercent}
                    onChange={(e) =>
                      handlePercentChange(
                        setLargeCapPercent,
                        e.target.value,
                        midCapPercent,
                        smallCapPercent,
                        setMidCapPercent,
                        setSmallCapPercent
                      )
                    }
                    className={`${THEMES[theme].input} mt-1 p-2 w-full rounded-md`}
                    min="0"
                    max="100"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium mb-1">Mid Cap Allocation (%)</label>
                  <input
                    type="number"
                    value={midCapPercent}
                    onChange={(e) =>
                      handlePercentChange(
                        setMidCapPercent,
                        e.target.value,
                        largeCapPercent,
                        smallCapPercent,
                        setLargeCapPercent,
                        setSmallCapPercent
                      )
                    }
                    className={`${THEMES[theme].input} mt-1 p-2 w-full rounded-md`}
                    min="0"
                    max="100"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium mb-1">Small Cap Allocation (%)</label>
                  <input
                    type="number"
                    value={smallCapPercent}
                    onChange={(e) =>
                      handlePercentChange(
                        setSmallCapPercent,
                        e.target.value,
                        largeCapPercent,
                        midCapPercent,
                        setLargeCapPercent,
                        setMidCapPercent
                      )
                    }
                    className={`${THEMES[theme].input} mt-1 p-2 w-full rounded-md`}
                    min="0"
                    max="100"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium mb-1">Large Cap CAGR (%)</label>
                  <input
                    type="number"
                    value={largeCapCAGR}
                    onChange={(e) => setLargeCapCAGR(Math.max(0, parseFloat(e.target.value) || 0))}
                    className={`${THEMES[theme].input} mt-1 p-2 w-full rounded-md`}
                    min="0"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium mb-1">Mid Cap CAGR (%)</label>
                  <input
                    type="number"
                    value={midCapCAGR}
                    onChange={(e) => setMidCapCAGR(Math.max(0, parseFloat(e.target.value) || 0))}
                    className={`${THEMES[theme].input} mt-1 p-2 w-full rounded-md`}
                    min="0"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium mb-1">Small Cap CAGR (%)</label>
                  <input
                    type="number"
                    value={smallCapCAGR}
                    onChange={(e) => setSmallCapCAGR(Math.max(0, parseFloat(e.target.value) || 0))}
                    className={`${THEMES[theme].input} mt-1 p-2 w-full rounded-md`}
                    min="0"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium mb-1">FD Rate (%)</label>
                  <input
                    type="number"
                    value={fdRate}
                    onChange={(e) => setFdRate(Math.max(0, parseFloat(e.target.value) || 0))}
                    className={`${THEMES[theme].input} mt-1 p-2 w-full rounded-md`}
                    min="0"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium mb-1">Inflation Rate (%)</label>
                  <input
                    type="number"
                    value={inflationRate}
                    onChange={(e) => setInflationRate(Math.max(0, parseFloat(e.target.value) || 0))}
                    className={`${THEMES[theme].input} mt-1 p-2 w-full rounded-md`}
                    min="0"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium mb-1">Tax Rate (%)</label>
                  <input
                    type="number"
                    value={taxRate}
                    onChange={(e) => setTaxRate(Math.max(0, parseFloat(e.target.value) || 0))}
                    className={`${THEMES[theme].input} mt-1 p-2 w-full rounded-md`}
                    min="0"
                  />
                </div>
              </div>
              {!isValidPercent && (
                <p className="text-red-400 mt-4">Total allocation must equal 100%. Current total: {totalPercent}%</p>
              )}
            </div>

            {isValidPercent && goals.length > 0 && (
              <div className={`${THEMES[theme].card} p-6 rounded-lg mb-8 ${THEMES[theme].border}`}>
                <div className="flex justify-between items-center mb-4">
                  <h2 className="text-xl font-semibold">Multi-Goal Planner</h2>
                  <button
                    onClick={addGoal}
                    className={`${THEMES[theme].buttonSecondary} px-3 py-1 rounded-md text-sm`}
                  >
                    Add Goal
                  </button>
                </div>
                
                <div className="overflow-x-auto rounded-lg mb-4">
                  <table className="w-full text-sm">
                    <thead>
                      <tr className={`${THEMES[theme].tableHeader}`}>
                        <th className="p-3 text-left font-bold">Goal Name</th>
                        <th className="p-3 text-left font-bold">Amount (â‚¹)</th>
                        <th className="p-3 text-left font-bold">Duration (Years)</th>
                        <th className="p-3 text-left font-bold">Required SIP (â‚¹)</th>
                      </tr>
                    </thead>
                    <tbody>
                      {goals.map((goal) => (
                        <tr key={goal.id} className={`border-b ${THEMES[theme].tableRowHover}`}>
                          <td className="p-3">
                            <input
                              type="text"
                              value={goal.name}
                              onChange={(e) => updateGoal(goal.id, 'name', e.target.value)}
                              className={`${THEMES[theme].input} p-2 w-full rounded-md`}
                            />
                          </td>
                          <td className="p-3">
                            <input
                              type="number"
                              value={goal.amount}
                              onChange={(e) => updateGoal(goal.id, 'amount', Math.max(0, parseFloat(e.target.value) || 0))}
                              className={`${THEMES[theme].input} p-2 w-full rounded-md`}
                              min="0"
                            />
                          </td>
                          <td className="p-3">
                            <input
                              type="number"
                              value={goal.years}
                              onChange={(e) => updateGoal(goal.id, 'years', Math.max(1, parseInt(e.target.value) || 1))}
                              className={`${THEMES[theme].input} p-2 w-full rounded-md`}
                              min="1"
                            />
                          </td>
                          <td className="p-3 font-medium">{formatNumber(goal.requiredSIP)}</td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
                
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  {goals.map((goal) => (
                    <div key={goal.id} className={`${THEMES[theme].card} p-4 rounded-lg`}>
                      <h3 className="font-medium mb-2">{goal.name}</h3>
                      <p className="text-sm opacity-80 mb-1">Target: {formatNumber(goal.amount)} in {goal.years} years</p>
                      <p className="font-semibold">Required Monthly SIP: {formatNumber(goal.requiredSIP)}</p>
                    </div>
                  ))}
                </div>
              </div>
            )}

            {isValidPercent && results.length > 0 && (
              <div ref={reportRef}>
                <div className={`${THEMES[theme].card} p-6 rounded-lg mb-8 ${THEMES[theme].border}`}>
                  <h2 className="text-xl font-semibold mb-4">SIP Allocation</h2>
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div>
                      <div className="grid grid-cols-3 gap-4 mb-6">
                        <div className={`${THEMES[theme].card} p-4 rounded-lg text-center border-l-4 ${THEMES[theme].largeCapBorder}`}>
                          <p className="text-sm font-medium">Large Cap</p>
                          <p className="text-lg font-bold">{formatNumber((sipAmount * largeCapPercent) / 100)}</p>
                          <p className="text-xs opacity-80">{largeCapPercent}%</p>
                        </div>
                        <div className={`${THEMES[theme].card} p-4 rounded-lg text-center border-l-4 ${THEMES[theme].midCapBorder}`}>
                          <p className="text-sm font-medium">Mid Cap</p>
                          <p className="text-lg font-bold">{formatNumber((sipAmount * midCapPercent) / 100)}</p>
                          <p className="text-xs opacity-80">{midCapPercent}%</p>
                        </div>
                        <div className={`${THEMES[theme].card} p-4 rounded-lg text-center border-l-4 ${THEMES[theme].smallCapBorder}`}>
                          <p className="text-sm font-medium">Small Cap</p>
                          <p className="text-lg font-bold">{formatNumber((sipAmount * smallCapPercent) / 100)}</p>
                          <p className="text-xs opacity-80">{smallCapPercent}%</p>
                        </div>
                      </div>
                      {lumpsumAmount > 0 && (
                        <>
                          <h3 className="text-md font-medium mb-2">Lumpsum Allocation</h3>
                          <div className="grid grid-cols-3 gap-4">
                            <div className={`${THEMES[theme].card} p-3 rounded-lg text-center border-l-4 ${THEMES[theme].largeCapBorder}`}>
                              <p className="text-sm">Large Cap</p>
                              <p className="font-medium">{formatNumber((lumpsumAmount * largeCapPercent) / 100)}</p>
                            </div>
                            <div className={`${THEMES[theme].card} p-3 rounded-lg text-center border-l-4 ${THEMES[theme].midCapBorder}`}>
                              <p className="text-sm">Mid Cap</p>
                              <p className="font-medium">{formatNumber((lumpsumAmount * midCapPercent) / 100)}</p>
                            </div>
                            <div className={`${THEMES[theme].card} p-3 rounded-lg text-center border-l-4 ${THEMES[theme].smallCapBorder}`}>
                              <p className="text-sm">Small Cap</p>
                              <p className="font-medium">{formatNumber((lumpsumAmount * smallCapPercent) / 100)}</p>
                            </div>
                          </div>
                        </>
                      )}
                    </div>
                    <div>
                      {PieChart && (
                        <ResponsiveContainer width="100%" height={300}>
                          <PieChart>
                            <Pie
                              data={[
                                { name: 'Large Cap', value: largeCapPercent },
                                { name: 'Mid Cap', value: midCapPercent },
                                { name: 'Small Cap', value: smallCapPercent },
                              ]}
                              cx="50%"
                              cy="50%"
                              outerRadius={80}
                              innerRadius={50}
                              paddingAngle={5}
                              dataKey="value"
                              label={({ name, percent }) => `${name} ${(percent * 100).toFixed(0)}%`}
                            >
                              {[
                                { name: 'Large Cap', value: largeCapPercent },
                                { name: 'Mid Cap', value: midCapPercent },
                                { name: 'Small Cap', value: smallCapPercent },
                              ].map((entry, index) => (
                                <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
                              ))}
                            </Pie>
                            <Tooltip 
                              formatter={(value) => [`${value}%`, 'Allocation']}
                            />
                            <Legend 
                              layout="horizontal"
                              verticalAlign="bottom"
                              align="center"
                              wrapperStyle={{ paddingTop: '20px' }}
                            />
                          </PieChart>
                        </ResponsiveContainer>
                      )}
                    </div>
                  </div>
                </div>

                <div className={`${THEMES[theme].card} p-6 rounded-lg mb-8 ${THEMES[theme].border}`}>
                  <h2 className="text-xl font-semibold mb-4">SIP vs FD Comparison</h2>
                  {LineChart && (
                    <ResponsiveContainer width="100%" height={400}>
                      <LineChart data={results} margin={{ top: 20, right: 30, left: 20, bottom: 5 }}>
                        <CartesianGrid strokeDasharray="3 3" stroke={theme === 'cosmic' ? '#2d2d5a' : '#e0e0e0'} />
                        <XAxis 
                          dataKey="year" 
                          fontSize={12} 
                          tick={{ fill: theme === 'cosmic' ? '#a0a0c0' : '#666' }}
                        />
                        <YAxis
                          fontSize={12}
                          tick={{ fill: theme === 'cosmic' ? '#a0a0c0' : '#666' }}
                          tickFormatter={(value) =>
                            value >= 10000000
                              ? `${(value / 1000000).toFixed(1)}M`
                              : value >= 1000
                              ? `${(value / 1000).toFixed(1)}K`
                              : value
                          }
                        />
                        <Tooltip
                          formatter={(value) => formatNumber(value)}
                          labelFormatter={(label) => label}
                          contentStyle={{
                            background: theme === 'cosmic' ? '#1a1a3a' : '#fff',
                            borderColor: theme === 'cosmic' ? '#4e2a8e' : '#ddd',
                            borderRadius: '8px',
                          }}
                        />
                        <Legend />
                        <Line 
                          type="monotone" 
                          dataKey="totalValue" 
                          name="SIP Value" 
                          stroke="#4e2a8e" 
                          strokeWidth={2}
                          dot={{ fill: '#4e2a8e', strokeWidth: 2, r: 4 }}
                        />
                        <Line 
                          type="monotone" 
                          dataKey="fdValue" 
                          name="FD Value" 
                          stroke="#00c9b8" 
                          strokeWidth={2}
                          dot={{ fill: '#00c9b8', strokeWidth: 2, r: 4 }}
                        />
                        <Line 
                          type="monotone" 
                          dataKey="postTaxValue" 
                          name="Post-Tax SIP Value" 
                          stroke="#ff2d75" 
                          strokeWidth={2}
                          dot={{ fill: '#ff2d75', strokeWidth: 2, r: 4 }}
                        />
                        <Line 
                          type="monotone" 
                          dataKey="realValue" 
                          name="Real Value (Inflation-Adjusted)" 
                          stroke="#00a8ff" 
                          strokeWidth={2}
                          dot={{ fill: '#00a8ff', strokeWidth: 2, r: 4 }}
                        />
                      </LineChart>
                    </ResponsiveContainer>
                  )}
                </div>

                <div className={`${THEMES[theme].card} p-6 rounded-lg mb-8 ${THEMES[theme].border}`}>
                  <div className="flex justify-between items-center mb-4">
                    <h2 className="text-xl font-semibold">Year-wise SIP Growth</h2>
                    <div className="flex gap-2">
                      <div className="flex items-center">
                        <span className="w-3 h-3 bg-blue-400 rounded-full mr-1"></span>
                        <p className="text-xs">Thousands</p>
                      </div>
                      <div className="flex items-center">
                        <span className="w-3 h-3 bg-teal-400 rounded-full mr-1"></span>
                        <p className="text-xs">Lakhs</p>
                      </div>
                      <div className="flex items-center">
                        <span className="w-3 h-3 bg-pink-400 rounded-full mr-1"></span>
                        <p className="text-xs">Crores</p>
                      </div>
                    </div>
                  </div>
                  
                  <div className="mb-4">
                    <h3 className="text-md font-medium mb-2">Customize Columns</h3>
                    <div className="flex flex-wrap gap-2">
                      {columns.map((col) => (
                        <label key={col.key} className="flex items-center text-sm">
                          <input
                            type="checkbox"
                            checked={visibleColumns.includes(col.key)}
                            onChange={() => !col.mandatory && toggleColumn(col.key)}
                            disabled={col.mandatory}
                            className="mr-2"
                          />
                          {col.label}
                        </label>
                      ))}
                    </div>
                  </div>
                  
                  <div className="overflow-x-auto rounded-lg">
                    <table className="w-full text-sm">
                      <thead>
                        <tr className={THEMES[theme].tableHeader}>
                          {columns.map((col) => (
                            visibleColumns.includes(col.key) && (
                              <th
                                key={col.key}
                                className={`p-3 text-left font-bold ${col.border ? `border-l-2 ${col.border}` : ''}`}
                              >
                                {col.label}
                              </th>
                            )
                          ))}
                        </tr>
                      </thead>
                      <tbody>
                        {results.map((row, index) => (
                          <tr
                            key={row.year}
                            className={`border-b ${THEMES[theme].tableRowHover}`}
                          >
                            {visibleColumns.includes('year') && (
                              <td className="p-3 font-medium">{row.year}</td>
                            )}
                            {visibleColumns.includes('largeCapInvested') && (
                              <td className={`p-3 text-right ${THEMES[theme].largeCapBorder ? `border-l-2 ${THEMES[theme].largeCapBorder}` : ''}`}>
                                {formatNumber(row.largeCapInvested)}
                              </td>
                            )}
                            {visibleColumns.includes('largeCapValue') && (
                              <td className={`p-3 text-right ${THEMES[theme].largeCapBorder ? `border-l-2 ${THEMES[theme].largeCapBorder}` : ''}`}>
                                {formatNumber(row.largeCapValue)}
                              </td>
                            )}
                            {visibleColumns.includes('midCapInvested') && (
                              <td className={`p-3 text-right ${THEMES[theme].midCapBorder ? `border-l-2 ${THEMES[theme].midCapBorder}` : ''}`}>
                                {formatNumber(row.midCapInvested)}
                              </td>
                            )}
                            {visibleColumns.includes('midCapValue') && (
                              <td className={`p-3 text-right ${THEMES[theme].midCapBorder ? `border-l-2 ${THEMES[theme].midCapBorder}` : ''}`}>
                                {formatNumber(row.midCapValue)}
                              </td>
                            )}
                            {visibleColumns.includes('smallCapInvested') && (
                              <td className={`p-3 text-right ${THEMES[theme].smallCapBorder ? `border-l-2 ${THEMES[theme].smallCapBorder}` : ''}`}>
                                {formatNumber(row.smallCapInvested)}
                              </td>
                            )}
                            {visibleColumns.includes('smallCapValue') && (
                              <td className={`p-3 text-right ${THEMES[theme].smallCapBorder ? `border-l-2 ${THEMES[theme].smallCapBorder}` : ''}`}>
                                {formatNumber(row.smallCapValue)}
                              </td>
                            )}
                            {visibleColumns.includes('totalInvested') && (
                              <td className={`p-3 text-right ${THEMES[theme].totalBorder ? `border-l-2 ${THEMES[theme].totalBorder}` : ''}`}>
                                {formatNumber(row.totalInvested)}
                              </td>
                            )}
                            {visibleColumns.includes('totalValue') && (
                              <td className={`p-3 text-right ${THEMES[theme].totalBorder ? `border-l-2 ${THEMES[theme].totalBorder}` : ''}`}>
                                {formatNumber(row.totalValue)}
                              </td>
                            )}
                            {visibleColumns.includes('profit') && (
                              <td className={`p-3 text-right ${THEMES[theme].totalBorder ? `border-l-2 ${THEMES[theme].totalBorder}` : ''}`}>
                                <div className="flex items-center justify-end gap-2">
                                  {formatNumber(row.profit)}
                                  <div className="w-16">
                                    <ChartErrorBoundary>
                                      <LineChart
                                        width={60}
                                        height={20}
                                        data={sparklineData.slice(0, index + 1)}
                                      >
                                        <Line
                                          type="monotone"
                                          dataKey="profit"
                                          stroke="#ff2d75"
                                          strokeWidth={2}
                                          dot={false}
                                        />
                                      </LineChart>
                                    </ChartErrorBoundary>
                                  </div>
                                </div>
                              </td>
                            )}
                            {visibleColumns.includes('tax') && (
                              <td className={`p-3 text-right ${THEMES[theme].totalBorder ? `border-l-2 ${THEMES[theme].totalBorder}` : ''}`}>
                                {formatNumber(row.tax)}
                              </td>
                            )}
                            {visibleColumns.includes('postTaxValue') && (
                              <td className={`p-3 text-right ${THEMES[theme].totalBorder ? `border-l-2 ${THEMES[theme].totalBorder}` : ''}`}>
                                {formatNumber(row.postTaxValue)}
                              </td>
                            )}
                            {visibleColumns.includes('realValue') && (
                              <td
                                className={`p-3 text-right ${THEMES[theme].totalBorder ? `border-l-2 ${THEMES[theme].totalBorder}` : ''} ${getRealValueColorAndIcon(row.realValue).className}`}
                              >
                                <div className="flex items-center justify-end gap-2">
                                  <span className="text-base">{getRealValueColorAndIcon(row.realValue).icon}</span>
                                  {formatNumber(row.realValue)}
                                  <div className="w-16">
                                    <ChartErrorBoundary>
                                      <LineChart
                                        width={60}
                                        height={20}
                                        data={sparklineData.slice(0, index + 1)}
                                      >
                                        <Line
                                          type="monotone"
                                          dataKey="realValue"
                                          stroke="#00a8ff"
                                          strokeWidth={2}
                                          dot={false}
                                        />
                                      </LineChart>
                                    </ChartErrorBoundary>
                                  </div>
                                </div>
                              </td>
                            )}
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                </div>

                <div className={`${THEMES[theme].card} p-6 rounded-lg ${THEMES[theme].border}`}>
                  <h2 className="text-xl font-semibold mb-4">SIP Growth Over Time</h2>
                  {LineChart && (
                    <ResponsiveContainer width="100%" height={400}>
                      <LineChart data={results} margin={{ top: 20, right: 30, left: 20, bottom: 5 }}>
                        <CartesianGrid strokeDasharray="3 3" stroke={theme === 'cosmic' ? '#2d2d5a' : '#e0e0e0'} />
                        <XAxis 
                          dataKey="year" 
                          fontSize={12} 
                          tick={{ fill: theme === 'cosmic' ? '#a0a0c0' : '#666' }}
                        />
                        <YAxis
                          fontSize={12}
                          tick={{ fill: theme === 'cosmic' ? '#a0a0c0' : '#666' }}
                          tickFormatter={(value) =>
                            value >= 10000000
                              ? `${(value / 1000000).toFixed(1)}M`
                              : value >= 1000
                              ? `${(value / 1000).toFixed(1)}K`
                              : value
                          }
                        />
                        <Tooltip
                          formatter={(value) => formatNumber(value)}
                          labelFormatter={(label) => label}
                          contentStyle={{
                            background: theme === 'cosmic' ? '#1a1a3a' : '#fff',
                            borderColor: theme === 'cosmic' ? '#4e2a8e' : '#ddd',
                            borderRadius: '8px',
                          }}
                        />
                        <Legend />
                        <Line 
                          type="monotone" 
                          dataKey="largeCapValue" 
                          name="Large Cap Value" 
                          stroke="#4e2a8e" 
                          strokeWidth={2}
                          dot={{ fill: '#4e2a8e', strokeWidth: 2, r: 4 }}
                        />
                        <Line 
                          type="monotone" 
                          dataKey="midCapValue" 
                          name="Mid Cap Value" 
                          stroke="#00c9b8" 
                          strokeWidth={2}
                          dot={{ fill: '#00c9b8', strokeWidth: 2, r: 4 }}
                        />
                        <Line 
                          type="monotone" 
                          dataKey="smallCapValue" 
                          name="Small Cap Value" 
                          stroke="#ff2d75" 
                          strokeWidth={2}
                          dot={{ fill: '#ff2d75', strokeWidth: 2, r: 4 }}
                        />
                        <Line 
                          type="monotone" 
                          dataKey="totalValue" 
                          name="Total Value" 
                          stroke="#00a8ff" 
                          strokeWidth={2}
                          dot={{ fill: '#00a8ff', strokeWidth: 2, r: 4 }}
                        />
                      </LineChart>
                    </ResponsiveContainer>
                  )}
                </div>
              </div>
            )}
          </div>
        </ErrorBoundary>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>